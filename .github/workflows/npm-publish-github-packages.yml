name: Build Android APK

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'  # âœ… ØªØºÛŒÛŒØ± Ø§Ø² 18 Ø¨Ù‡ 20
        cache: 'npm'
    
    - name: Install specific React Native version
      run: |
        # Ù†ØµØ¨ React Native 0.72.6 Ú©Ù‡ Ø¨Ø§ Node 18 Ø³Ø§Ø²Ú¯Ø§Ø± Ø¨Ø§Ø´Ø¯
        npm install react-native@0.72.6 --legacy-peer-deps --save
        npm install @react-navigation/native@^6.1.9 @react-navigation/stack@^6.3.20 --legacy-peer-deps
        npm install react-native-screens@^3.22.0 react-native-safe-area-context@^4.6.3 --legacy-peer-deps
        npm install react-native-gesture-handler@^2.12.0 --legacy-peer-deps
        npm install @react-native-async-storage/async-storage@^1.18.2 --legacy-peer-deps
        npm install react-native-vector-icons@^9.2.0 --legacy-peer-deps  # Ù†Ø³Ø®Ù‡ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±
    
    - name: Create Android Project Structure
      run: |
        echo "ðŸš€ Creating Android project..."
        
        # Ø³Ø§Ø®ØªØ§Ø± Ø§ØµÙ„ÛŒ
        mkdir -p android/app/src/main/java/com/invoiceapp
        mkdir -p android/app/src/main/res
        mkdir -p android/gradle/wrapper
        
        # ÙØ§ÛŒÙ„ build.gradle Ø³Ø·Ø­ Ù¾Ø±ÙˆÚ˜Ù‡
        cat > android/build.gradle << 'EOF'
        buildscript {
            ext {
                buildToolsVersion = "33.0.0"
                minSdkVersion = 21
                compileSdkVersion = 33
                targetSdkVersion = 33
                ndkVersion = "23.1.7779620"
                kotlinVersion = "1.8.0"
            }
            repositories {
                google()
                mavenCentral()
            }
            dependencies {
                classpath("com.android.tools.build:gradle:7.3.1")
                classpath("com.facebook.react:react-native-gradle-plugin")
                classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion")
            }
        }
        EOF
        
        # ÙØ§ÛŒÙ„ app/build.gradle
        cat > android/app/build.gradle << 'EOF'
        apply plugin: "com.android.application"
        apply plugin: "com.facebook.react"
        apply plugin: "org.jetbrains.kotlin.android"
        
        project.ext.react = [
            enableHermes: true
        ]
        
        android {
            namespace "com.invoiceapp"
            compileSdkVersion rootProject.ext.compileSdkVersion
            
            defaultConfig {
                applicationId "com.invoiceapp"
                minSdkVersion rootProject.ext.minSdkVersion
                targetSdkVersion rootProject.ext.targetSdkVersion
                versionCode 1
                versionName "1.0"
            }
            
            signingConfigs {
                debug {
                    storeFile file('debug.keystore')
                    storePassword 'android'
                    keyAlias 'androiddebugkey'
                    keyPassword 'android'
                }
            }
            
            buildTypes {
                debug {
                    signingConfig signingConfigs.debug
                }
                release {
                    signingConfig signingConfigs.debug
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
                }
            }
        }
        
        dependencies {
            implementation("com.facebook.react:react-android")
            implementation("com.facebook.react:hermes-android")
            implementation("androidx.core:core-ktx:1.10.1")
        }
        
        apply from: file("../../node_modules/@react-native-community/cli-platform-android/native_modules.gradle")
        applyNativeModulesAppBuildGradle(project)
        EOF
        
        # ÙØ§ÛŒÙ„ gradle-wrapper.properties
        cat > android/gradle/wrapper/gradle-wrapper.properties << 'EOF'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-7.5.1-all.zip
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF
        
        # ÙØ§ÛŒÙ„ settings.gradle
        cat > android/settings.gradle << 'EOF'
        rootProject.name = 'InvoiceApp'
        apply from: file("../node_modules/@react-native-community/cli-platform-android/native_modules.gradle")
        applyNativeModulesSettingsGradle(settings)
        include ':app'
        EOF
        
        # ÙØ§ÛŒÙ„ gradle.properties
        cat > android/gradle.properties << 'EOF'
        android.useAndroidX=true
        android.enableJetifier=true
        org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
        org.gradle.parallel=true
        org.gradle.caching=true
        EOF
        
        # ÙØ§ÛŒÙ„ local.properties (Ø¨Ø±Ø§ÛŒ SDK Ù…Ø³ÛŒØ±)
        cat > android/local.properties << 'EOF'
        sdk.dir=/usr/local/lib/android/sdk
        ndk.dir=/usr/local/lib/android/sdk/ndk/23.1.7779620
        EOF
        
        echo "âœ… Android project structure created"
    
    - name: Build APK
      run: |
        cd android
        chmod +x gradlew
        # Ø§ÛŒØ¬Ø§Ø¯ debug.keystore
        keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
        ./gradlew assembleRelease --no-daemon
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: invoice-app
        path: android/app/build/outputs/apk/release/app-release.apk
