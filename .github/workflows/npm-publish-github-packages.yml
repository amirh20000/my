name: Build Android APK

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        # Ø­Ø°Ù cache Ú†ÙˆÙ† package-lock.json Ù†Ø¯Ø§Ø±ÛŒÙ…
    
    - name: Create package-lock.json
      run: |
        # Ø§Ú¯Ø± package-lock.json Ù†ÛŒØ³ØªØŒ Ø§ÛŒØ¬Ø§Ø¯Ø´ Ú©Ù†
        if [ ! -f "package-lock.json" ]; then
          echo "Creating package-lock.json..."
          npm init -y
          # Ù†ØµØ¨ dependencyÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
          npm install react-native@0.72.6 --save --legacy-peer-deps --package-lock-only
        fi
    
    - name: Install Dependencies
      run: |
        npm install --legacy-peer-deps --no-audit
    
    - name: Create Android Project
      run: |
        if [ ! -d "android" ]; then
          echo "ðŸš€ Creating Android project..."
          
          # Ø³Ø§Ø®ØªØ§Ø± Ø§ØµÙ„ÛŒ
          mkdir -p android/app/src/main/java/com/invoiceapp
          mkdir -p android/app/src/main/res/values
          mkdir -p android/gradle/wrapper
          
          # strings.xml
          cat > android/app/src/main/res/values/strings.xml << 'EOF'
          <resources>
              <string name="app_name">InvoiceApp</string>
          </resources>
          EOF
          
          # ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ gradle (Ù‡Ù…Ø§Ù† Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ)
          cat > android/build.gradle << 'EOF'
          buildscript {
              ext {
                  buildToolsVersion = "33.0.0"
                  minSdkVersion = 21
                  compileSdkVersion = 33
                  targetSdkVersion = 33
                  ndkVersion = "23.1.7779620"
                  kotlinVersion = "1.8.0"
              }
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath("com.android.tools.build:gradle:7.3.1")
                  classpath("com.facebook.react:react-native-gradle-plugin")
                  classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion")
              }
          }
          
          allprojects {
              repositories {
                  maven {
                      url("$rootDir/../node_modules/react-native/android")
                  }
                  maven {
                      url("$rootDir/../node_modules/jsc-android/dist")
                  }
                  google()
                  mavenCentral()
                  maven { url 'https://www.jitpack.io' }
              }
          }
          EOF
          
          # Ø§Ø¯Ø§Ù…Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ (Ú©Ø¯ Ú©Ø§Ù…Ù„ Ø§Ø² Ù‚Ø¨Ù„)
          # ...
          
          echo "âœ… Android project created"
        fi
    
    - name: Build APK
      run: |
        cd android
        chmod +x gradlew
        # Ø§Ú¯Ø± gradlew Ù†ÛŒØ³ØªØŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†
        if [ ! -f "gradlew" ]; then
          wget -q https://raw.githubusercontent.com/gradle/gradle/master/gradlew
          chmod +x gradlew
        fi
        ./gradlew assembleRelease --no-daemon
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: invoice-app
        path: android/app/build/outputs/apk/release/app-release.apk
