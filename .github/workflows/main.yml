name: Build Android APK

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Create Android project
      run: |
        if [ ! -d "android" ]; then
          echo "ğŸš€ Creating Android project..."
          
          # Ø±ÙˆØ´ Û±: Ø¯Ø§Ù†Ù„ÙˆØ¯ template Ø§Ø² branch Ù‚Ø¯ÛŒÙ…ÛŒ
          wget -q https://raw.githubusercontent.com/facebook/react-native/0.72-stable/template/android.tar.gz || \
          curl -L https://raw.githubusercontent.com/facebook/react-native/0.72-stable/template/android.tar.gz -o android.tar.gz
          
          if [ -f "android.tar.gz" ]; then
            tar -xzf android.tar.gz
            rm android.tar.gz
          else
            # Ø±ÙˆØ´ Û²: Ø§Ú¯Ø± ÙØ§ÛŒÙ„ tar Ù†Ø¨ÙˆØ¯ØŒ Ø§Ø² repo Ø§ØµÙ„ÛŒ clone Ú©Ù†ÛŒÙ…
            echo "Using alternative method..."
            git clone --depth 1 --branch 0.72-stable https://github.com/facebook/react-native.git temp-rn
            # Ø³Ø§Ø®ØªØ§Ø± Ø¬Ø¯ÛŒØ¯ React Native
            mkdir -p android
            # Ú©Ù¾ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ
            cp -r temp-rn/template/android/* android/ 2>/dev/null || true
            # Ø§Ú¯Ø± Ø³Ø§Ø®ØªØ§Ø± Ù‚Ø¯ÛŒÙ…ÛŒ Ø¨ÙˆØ¯
            if [ ! -f "android/app/build.gradle" ]; then
              cp -r temp-rn/template/_android/* android/ 2>/dev/null || true
            fi
            rm -rf temp-rn
          fi
          
          # ØªÙ†Ø¸ÛŒÙ… package name
          if [ -f "android/app/build.gradle" ]; then
            sed -i 's/com\.androidsample/com\.invoiceapp/g' android/app/build.gradle
            sed -i 's/AndroidSample/InvoiceApp/g' android/app/build.gradle
            echo "âœ… Android project created successfully"
          else
            echo "âŒ Failed to create Android project structure"
            exit 1
          fi
        else
          echo "ğŸ“ Android folder already exists"
        fi
    
    - name: Generate package-lock
      run: npm install --package-lock-only --legacy-peer-deps
    
    - name: Install dependencies
      run: npm install --legacy-peer-deps
    
    - name: Build APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleRelease --no-daemon
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: invoice-app
        path: android/app/build/outputs/apk/release/app-release.apk
